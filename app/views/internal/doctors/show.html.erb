<div class="card">

    <div class="card-header">
        <strong>Doctors</strong> - Doctor Detail
    </div>

    <div class="card-body">

        <%=render "/shared/all_flash" %>
        <%=render 'shared/all_validation_flash', { model_obj: @doctor } %>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :code %>
                    <p class="form-control-plaintext">
                        <%= @doctor.code || raw('<i>N/A</i>') %>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :company_name, "Company Name" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.company_name || raw('<i>N/A</i>') %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :title_id, "Title" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.title&.name || raw('<i>N/A</i>') %>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :name %>
                    <p class="form-control-plaintext">
                        <%= @doctor.name || raw('<i>N/A</i>') %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :clinic_name, "Clinic Name" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.clinic_name || raw('<i>N/A</i>') %>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :icno, "ICNO" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.icno || raw('<i>N/A</i>') %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :business_registration_number, "Business Registration Number" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.business_registration_number || raw('<i>N/A</i>') %>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :created_at, "Registration Date" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.created_at.try(:strftime,get_standard_date_format) || raw('<i>N/A</i>') %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :nationality_id, "Nationality" %>
                    <p class="form-control-plaintext">
                        <% if !@doctor.nationality_id.blank? %>
                            <%= Country.find(@doctor.nationality_id)&.name || raw('<i>N/A</i>') %>
                        <% end %>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :race_id, "Race/Ethnic" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.race&.name || raw('<i>N/A</i>') %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :gender, "Gender" %>
                    <p class="form-control-plaintext">
                    <% if @doctor.gender=='M'%>
                         <p>Male</p>
                    <% elsif @doctor.gender=='F' %>
                         <p>Female</p>
                    <% else @doctor.gender== nil %>
                         <p>N/A</p>
                    <% end %>
                    </p>
                </div>
            </div>
        </div>

        <!-- address -->
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <%= label_tag :address %>
                    <p class="form-control-plaintext">
                        <%= @doctor.address1 %>
                    </p>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <p class="form-control-plaintext">
                        <%= @doctor.address2 %>
                    </p>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <p class="form-control-plaintext">
                        <%= @doctor.address3 %>
                    </p>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <p class="form-control-plaintext">
                        <%= @doctor.address4 %>
                    </p>
                </div>
            </div>
        </div>
        <!-- /address -->

        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <%= label_tag :state %>
                    <p class="form-control-plaintext">
                        <%= @doctor.state.try(:name) %>
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <%= label_tag :town %>
                    <p class="form-control-plaintext">
                        <%= @doctor.town.try(:name) %>
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <%= label_tag :postcode %>
                    <p class="form-control-plaintext">
                        <%= @doctor.postcode %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :phone_number, "Phone Number" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.phone %>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :fax_number, "Fax Number" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.fax %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :mobile_number, "Mobile Number" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.mobile %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :email %>
                    <p class="form-control-plaintext">
                        <%= @doctor.email %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :qualification %>
                    <p class="form-control-plaintext">
                        <%= @doctor.qualification %>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :renewal_agreement_date, "Renewal Agreement Date" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.renewal_agreement_date.try(:strftime,'%d/%m/%Y') %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :apc_number, "APC Number" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.apc_number %>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :apc_year, "APC Year" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.apc_year %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :doctor_association, "Doctor's Association" %>
                    <p class="form-control-plaintext">
                          <%= @doctor.has_doctor_association ? 'Yes' : 'No' %>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :associations, "Name of Association" %>
                    <p class="form-control-plaintext">
                        <% if !@doctor.associations.blank? %>
                            <% @doctor.associations["association"].each do |ar_id| %>
                                <% if !ar_id.blank? %>
                                    <% ar = Association.find(ar_id) %>
                                    <div><%= ar.name %></div>
                                <% end %>
                            <% end %>
                        <% else %>
                            <div>N/A</div>
                        <% end %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :district_health_office_id, "Nearest District Health Office" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.district_health_office.try(:name) %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :fp_device, "FP Device" %>
                    <p class="form-control-plaintext">
                        <%= Doctor::FP_DEVICES[@doctor.fp_device.to_s] %>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :paid_biometric_device, "Paid for Biometric Device" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.paid_biometric_device ? 'Yes' : @doctor.paid_biometric_device.nil? ? '' : 'No' %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :status %>
                    <p class="form-control-plaintext">
                        <%= Doctor::STATUSES[@doctor.status] %>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :activated_at, "Activated At" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.activated_at.nil? ? (raw '<i>N/A</i>') : @doctor.activated_at.strftime(get_standard_date_format) %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Annual Quota</label>

                    <p class="form-control-plaintext">
                        <%= @doctor.quota %>
                    </p>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <label>Assigned Quota</label>
                    <i class="far fa-question-circle ml-2 clickable d-none" style="font-size: 1.3em; color: #777;" aria-hidden="true" data-toggle="tooltip" title="Additional quota assigned to this doctor. If the value is negative, it lowers the quota instead. Resets to 0 at the start of each year."></i>

                    <p class="form-control-plaintext">
                        <%= @doctor.quota_modifier %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Used Quota</label>
                    <!-- <i class="far fa-question-circle ml-2 clickable" style="font-size: 1.3em; color: #777;" aria-hidden="true" data-toggle="tooltip" title="Quota already used for this doctor this year. Resets to 0 at the start of each year."></i> -->

                    <p class="form-control-plaintext">
                        <%= @doctor.quota_used + @doctor.quota_pending_on_order %>
                    </p>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :displayed_quota, "Quota" %>
                    <!-- <i class="far fa-question-circle ml-2 clickable" style="font-size: 1.3em; color: #777;" aria-hidden="true" data-toggle="tooltip" title="This is the quota that user's see. It is calculated by 'Annual quota' + 'Assigned quota'."></i> -->

                    <p class="form-control-plaintext">
                        <%= @doctor.displayed_quota %>
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :quota_available, "Quota Available" %>
                    <!-- <i class="far fa-question-circle ml-2 clickable" style="font-size: 1.3em; color: #777;" aria-hidden="true" data-toggle="tooltip" title="This is the available quota that the doctor has remaining. It is calculated by 'Annual quota' + 'Assigned quota' - 'Used quota'."></i> -->

                    <p class="form-control-plaintext">
                        <%= @doctor.available_quota %>
                    </p>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :over_quota, "Over Quota" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.displayed_quota <= @doctor.quota_used ? 'Yes' : 'No' %>
                    </p>
                </div>
            </div>
        </div>

        <% if @doctor.status != 'ACTIVE' %>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :status_reason, "Status (Reason)" %>
                    <p class="form-control-plaintext">
                        <%= Doctor::ALL_STATUS_REASONS[@doctor.status_reason] || raw('<i>N/A</i>') %>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <%= label_tag :status_comment, "Status (Comment)" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.status_comment || raw('<i>N/A</i>') %>
                    </p>
                </div>
            </div>
        </div>
        <% end %>

        <div class="row">
            <div class="col-md-6">
                <%= label_tag :service_provider_group_id, "Service Provider Group" %>
                <p class="form-control-plaintext">
                    <%= @doctor.service_provider_group&.name || raw('<i>N/A</i>') %>
                </p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <%= label_tag :solo_clinic, "No of Solo Clinics" %>
                <p class="form-control-plaintext">
                    <%= @doctor.solo_clinic || 0 %>
                </p>
            </div>
            <div class="col-md-6">
                <%= label_tag :group_clinic, "No of Group Clinics" %>
                <p class="form-control-plaintext">
                    <%= @doctor.group_clinic || 0 %>
                </p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <%= label_tag :has_xray, "Own X-Ray Clinic" %>
                <p class="form-control-plaintext">
                    <%= @doctor.has_xray ? 'Yes' : 'No' %>
                </p>
            </div>
        </div>

          <div class="row">
            <div class="col-md-6">
                <%= label_tag :has_selected_re_medical, "Selected For Re-Medical" %>
                <p class="form-control-plaintext">
                    <%= @doctor.has_selected_re_medical ? 'Yes' : 'No' %>
                </p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <%= label_tag :xray_facility_id, "X-Ray Facility" %>
                <p class="form-control-plaintext">
                    <%= @doctor.xray_facility.blank? ? raw('<i>N/A</i>') : (link_to "#{@doctor.xray_facility&.name} (#{@doctor.xray_facility&.code})", internal_xray_facility_path(@doctor.xray_facility), target: "_BLANK") %>
                </p>
            </div>
            <div class="col-md-6">
                <%= label_tag :laboratory_id, "Laboratory Facility" %>
                <p class="form-control-plaintext">
                    <%= @doctor.laboratory.blank? ? raw('<i>N/A</i>') : (link_to "#{@doctor.laboratory&.name} (#{@doctor.laboratory&.code})", internal_laboratory_path(@doctor.laboratory), target: "_BLANK") %>
                </p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <%= label_tag :xray_facility_pairing_recommendations, "X-Ray Facility Pairing Recommendations" %>
                <p class="ml-4 blank-selected-placeholder <%= "hidden" if @xray_facilities.present? %>" data-type="xray">No x-ray facilities selected</p>

                <ul class="list-parent" data-type="xray" id="xray-list">
                    <% @xray_facilities.each do |xray_facility| %>
                        <li><%= link_to "#{xray_facility&.name} (#{xray_facility&.code})", internal_xray_facility_path(xray_facility), target: "_BLANK" %></li>
                    <% end %>
                </ul>
            </div>

            <div class="col-md-6">
                <%= label_tag :laboratory_pairing_recommendations, "Laboratory Pairing Recommendations" %>
                <p class="ml-4 blank-selected-placeholder <%= "hidden" if @laboratory_facilities.present? %>" data-type="laboratory">No laboratories selected</p>

                <ul class="list-parent" data-type="laboratory" id="laboratory-list">
                    <% @laboratory_facilities.each do |laboratory| %>
                        <li><%= link_to "#{laboratory&.name} (#{laboratory&.code})", internal_laboratory_path(laboratory), target: "_BLANK" %></li>
                    <% end %>
                </ul>
            </div>
        </div>

        <% if has_permission?("VIEW_INSPECTORATE_DETAILS") %>
            <div class="row">
                <% current_year = Date.current.year %>
                <div class="col-md-6">
                    <%= label_tag :allocated_count, "No. Of Worker Allocated ("+current_year.to_s+")" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.quota_used %>
                    </p>
                </div>
                <div class="col-md-6">
                    <%= label_tag :certified_count, "No. Of Worker Certified ("+current_year.to_s+")" %>
                    <p class="form-control-plaintext">
                        <%= Transaction.have_assigned_doctor(@doctor.id).by_year('certification_date',current_year).count %>
                    </p>
                </div>
            </div>
        <% end %>

        <% if has_permission? "VIEW_FINANCE_INFO_DOCTOR" %>
            <div class="row">
                <div class="col-md-6">
                    <%= label_tag :male_rate, "Male Worker Rate (RM)" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.male_rate %>
                    </p>
                </div>
                <div class="col-md-6">
                    <%= label_tag :female_rate, "Female Worker Rate (RM)" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.female_rate %>
                    </p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <%= label_tag :bank_id, "Bank" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.bank&.name %>
                    </p>
                </div>
                <div class="col-md-6">
                    <%= label_tag :bank_account_number, "Bank Account Number" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.bank_account_number %>
                    </p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <%= label_tag :bank_payment_id, "Bank Payment ID" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.bank_payment_id %>
                    </p>
                </div>
                <div class="col-md-6">
                    <%= label_tag :payment_method_id, "Payment Method" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.payment_method&.name %>
                    </p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <%= label_tag :email_payment, "Email (Payment)" %>
                    <p class="form-control-plaintext">
                        <%= @doctor.email_payment %>
                    </p>
                </div>
            </div>
        <% end %>

    </div>
    <!-- /card-body -->

    <div class="card-footer">
        <style>
            form.button_to {
                display: inline;
            }
        </style>

        <div class="text-right">
            <%=raw show_back_button(internal_doctors_path) %>

            <% if !@doctor.registration_approved_at.nil? and @doctor.activated_at.nil? %>
                <% if @doctor.registration_paid? %>
                    <%= button_to "Activate", {action: 'activate', id: @doctor.id}, {method: :patch, class: 'btn btn-sm btn-primary', data: {confirm: 'Confirm activate?'}} if has_permission?("ACTIVATE_DOCTOR") %>
                <% else %>
                    <%= link_to "Payment", edit_internal_order_path(@doctor.registration_order), class: "btn btn-sm btn-primary" if has_permission?("VIEW_MSPD_ORDER") %>
                <% end %>
            <% end %>

            <% if can_request_update?(@doctor) and has_any_permission?("EDIT_NON_FINANCE_INFO_DOCTOR", "EDIT_FINANCE_INFO_DOCTOR") %>
                <%=raw show_edit_button edit_internal_doctor_path(@doctor) %>
            <% end %>
        </div>

    </div>

</div>

<div class="card">
    <div class="card-body">
        <ul class="list-group">
            <% if has_permission?("VIEW_DOCUMENT_DOCTOR") %>
                <% if !@doctor.registration_approved_at.nil? %>
                    <li class="list-group-item">
                        <%= link_to "Registration Letter", registration_letter_internal_doctor_path(@doctor) %> |
                        <%= link_to "Registration Invoice", registration_invoice_internal_doctor_path(@doctor), target: "_BLANK" %>
                    </li>
                    <li class="list-group-item"><%= link_to "Change Address Approval Letter", change_address_approval_internal_doctor_path(@doctor) %></li>
                    <li class="list-group-item"><%= link_to "Pairing Notification Letter", pairing_letter_internal_doctor_path(@doctor) %></li>
                    <li class="list-group-item">
                        <%= link_to "Laboratory Allocation Letter", allocation_letter_internal_doctor_path(@doctor, service_provider: Laboratory.to_s) %> |
                        <%= link_to "X-Ray Facility Allocation Letter", allocation_letter_internal_doctor_path(@doctor, service_provider: XrayFacility.to_s) %>
                    </li>
                    <li class="list-group-item">
                        <%= link_to "Temporary Laboratory Allocation Letter", temporary_allocation_letter_internal_doctor_path(@doctor, service_provider: Laboratory.to_s) %> |
                        <%= link_to "Temporary X-Ray Facility Allocation Letter", temporary_allocation_letter_internal_doctor_path(@doctor, service_provider: XrayFacility.to_s) %>
                    </li>
                    <li class="list-group-item">
                        <%= link_to "Laboratory Re-Allocation Back Letter", reallocation_back_letter_internal_doctor_path(@doctor, service_provider: Laboratory.to_s) %> |
                        <%= link_to "X-Ray Facility Re-Allocation Back Letter", reallocation_back_letter_internal_doctor_path(@doctor, service_provider: XrayFacility.to_s) %>
                    </li>
                <% end %>
            <% end %>

            <% if has_permission?("VIEW_STATUS_SCHEDULE") %>
                <li class="list-group-item">
                    <%= link_to "Status Schedules", internal_status_schedules_path(status_scheduleable_type: @doctor.class.name, status_scheduleable_code: @doctor.code) %>
                    <% if has_permission?("CREATE_STATUS_SCHEDULE") %>
                    | <%= link_to "Add", new_internal_status_schedule_path(status_scheduleable_type: @doctor.class.name, status_scheduleable_code: @doctor.code) %>
                    <% end %>
                </li>
            <% end %>

            <% if has_permission?("VIEW_GROUP_SCHEDULE") %>
                <li class="list-group-item">
                    <%= link_to "SP Group Schedules", internal_group_schedules_path(sp_schedulable_type: @doctor.class.name, sp_schedulable_code: @doctor.code) %>
                    <% if has_permission?("CREATE_GROUP_SCHEDULE") %>
                    | <%= link_to "Add", new_internal_group_schedule_path(sp_schedulable_type: @doctor.class.name, sp_schedulable_code: @doctor.code) %>
                    <% end %>
                </li>
            <% end %>

            <% if has_permission?("VIEW_AUDIT_DOCTOR") %>
                <li class="list-group-item">
                    <%= link_to "Audits", internal_doctor_audits_path(@doctor) %>
                </li>
            <% end %>

            <% if has_permission?("VIEW_OPERATION_HOUR_DOCTOR") %>
                <li class="list-group-item"><%= link_to "Operation Hour", operation_hours_internal_doctors_path(@doctor) %></li>
            <% end %>

            <% if has_permission?('MSPD_REPORTS') %>
                <li class="list-group-item">
                    <%= link_to "Allocated Workers", allocated_workers_internal_doctor_path(@doctor) %>
                </li>
                <li class="list-group-item">
                    <%= link_to "Summary Loading Statistics", summary_loading_statistic_internal_doctor_path(@doctor) %>
                </li>
                <li class="list-group-item"><%= link_to "Suspension/Lifting History", suspension_history_internal_doctor_path(@doctor) %></li>
            <% end %>

            <% if has_permission?('VIEW_COUPLING_HISTORY') %>
                <li class="list-group-item"><%= link_to "Coupling History", coupling_history_internal_doctor_path(@doctor) %></li>
            <% end %>
        </ul>
    </div>
</div>